# blproof - Blind liability proof

My attempt at implementing gmaxwell's
["prove-how-(non)-fractional-your-Bitcoin-reserves-are
scheme"](https://iwilcox.me.uk/v/nofrac). 

This project only implements
the "liability" part of the solvency proof (how many bitcoins the
operator SHOULD have - thier liabilities). 

The proof that the operator DOES have the funds to cover all its liabilities 
can be done using Bitcoin's signmessage feature. The complete scheme
will be described in details eventually.
 
Beer fund: 1ECyyu39RtDNAuk3HRCRWwD4syBF2ZGzdx

## Install

```
npm install blproof
```

## CLI Usage

```
# Create private merkle tree from an accounts file (see
# test/account.json for format)

$ blproof privatetree -f test/accounts.json --human
$ blproof privatetree -f test/accounts.json > private.json

# Extract public tree for user mark.

$ blproof publictree mark -f private.json --human
$ blproof publictree mark -f private.json > mark.json

# Display root node hash and value

$ blproof root -f private.json --human

# Verify public tree

$ blproof verify --hash SLpDal8kYJNdLwczp6wrU68FOFrpoHT3w5nd15HOpwU= --value 37618 -f mark.json
```

## Definitions

### Complete proof tree
  
The complete proof tree is a binary tree where the leaf nodes
represent all the user accounts and the interior nodes generated using the
NodeCombiner function described below.

The complete tree should be kept private by the operator in order to
protect the privacy of its users. Only the root node should be puslished
publicly and each individual user should have private access to their
own partial proof tree.

### Interior node (NodeCombiner function)

Interior nodes are generated using the NodeCombiner function described
below.

The node's value is equal to the sum of its two child node's values.

The node's hash is equal to the sha256 of its value concatenated with
its child's hashes.

```
function NodeCombiner (left_node, right_node) {
  var n = {};
  n.value = left_node.value + right_node.value;
  n.hash = sha256((left_node.value + right_node.value) + '' + left_node.hash + '' + right_node.hash);
  return n;
}
```

### Leaf node

Leaf nodes represent user accounts. They possess the following values:

  - `user`: A unique identifier for the user. It is necessary for a user
    to assess the uniqueness of this value so it is recommended to use their username or email.
  - `nonce`: A random nonce to prevent its neighboor node from discovering its `user` value
  - `value`: The user's balance.
  - `hash`: A sha256 hash of user concanetated with the nonce.


### Root node

The root node of the tree like all interior nodes possesses a hash and a
value. This data must be published publicly as a way to prove that all users
are part of the same proof tree.


### Partial proof tree

A partial proof contains only the nodes from the complete root a given
user needs to verify he was included in the tree. 

It can be generated by starting from the user's leaf node and moving up
the tree until reaching the root node. Then the sibblings of each
selected node on the path must be added to the tree. The user's leaf
sibling which is also a leaf node must be stripped of its `user` and
`nonce` values so that only the `hash` and `value` remain.

Partial trees should be disclosed privately to each individual users so
they can verify the proof.

## Some sample outputs

```
test$ node ./bsolp.js

Private tree:

37618, SLpDal8kYJNdLwczp6wrU68FOFrpoHT3w5nd15HOpwU=
 |_ 24614, uI5UdCraTo11wXQBED8hLN3VQnAPEZGRxMBC65NHfwU=
 | |_ 21072, jG3EVyBXVbVDWmELKyN6Bhr+tcJg73zkvanchWiWAuc=
 | | |_ 4167, tyHBvBgE8dzl1wZPrhJ7s3xrHE8NqOBHT5Gfyneop4U=
 | | | |_ 122, fBKXXjlikszxj1pP3vKf0BWTj9yeFTs+cuc+TAzqJwo=
 | | | | |_ 39, einstein
 | | | | |_ 83, picasso
 | | | |_ 4045, olalonde
 | | |_ 16905, z0AQfe2Xv+ZmZWaB6Cl4Tn1nixpf4KSnQoadl+KKjj4=
 | |   |_ 6905, gmaxwell
 | |   |_ 10000, satoshi
 | |_ 3542, 3EXM/8Q8JAJihU3nX3AdD1WgkXDrNeQgh0MRBJ6k60k=
 |   |_ 3327, HbDV2lywYbZlXiTmx27PU5YjAHMPAr6rKlIjFfEgxBg=
 |   | |_ 300, luke-jr
 |   | |_ 3027, sipa
 |   |_ 215, TxnypBHTR+aXh6ozKd5pnicdlEcBfVNLuXvuZb8cUhU=
 |     |_ 200, codeshark
 |     |_ 15, gribble
 |_ 13004, iaMffeZYdyGXcP4VKA5NIBWQeAlz8b2am4m7GR4pL8A=
   |_ 9901, GHuVUeCtEsr0o1PzDzEzNds6Qf1B334hKErZI9KybqE=
   | |_ 12, ReggpH0fv+rmTnLX3sfqLx21rEdoLaD5zJqst5C/ncM=
   | | |_ 0, alice
   | | |_ 12, bob
   | |_ 9889, SQswAyEUWZ5VoAwhIirvyE3IKDy+b64pZU9ZBv3sWT4=
   |   |_ 9427, charlie
   |   |_ 462, mark
   |_ 3103, SBk/MZZOWokTzs3K36ncgNoipsfi8Ua/LnPfoUemQts=
     |_ 3032, o+rBE22dMf3jI0SVGajIxt4a6ImyJq9V1cmvk9eSmhI=
     | |_ 12, anax
     | |_ 3020, gavin
     |_ 71, aRFnO4wgjO3q4qgbF3pqvkSlZHKQQAx+UnBviwAo84M=
       |_ 68, stacy
       |_ 3, justin

Root hash: SLpDal8kYJNdLwczp6wrU68FOFrpoHT3w5nd15HOpwU=
Root value: 37618
Extracting tree for mark:

37618, SLpDal8kYJNdLwczp6wrU68FOFrpoHT3w5nd15HOpwU=
 |_ 24614, uI5UdCraTo11wXQBED8hLN3VQnAPEZGRxMBC65NHfwU=
 |_ 13004, iaMffeZYdyGXcP4VKA5NIBWQeAlz8b2am4m7GR4pL8A=
   |_ 9901, GHuVUeCtEsr0o1PzDzEzNds6Qf1B334hKErZI9KybqE=
   | |_ 12, ReggpH0fv+rmTnLX3sfqLx21rEdoLaD5zJqst5C/ncM=
   | |_ 9889, SQswAyEUWZ5VoAwhIirvyE3IKDy+b64pZU9ZBv3sWT4=
   |   |_ 9427, charlie
   |   |_ 462, mark
   |_ 3103, SBk/MZZOWokTzs3K36ncgNoipsfi8Ua/LnPfoUemQts=
```

## References

[Reddit announcement](http://www.reddit.com/r/Bitcoin/comments/1yzil4/i_implemented_gmaxwells/)
[HN post](https://news.ycombinator.com/item?id=7277865)
[Example of how a shared wallet website could use the CLI](http://www.reddit.com/r/Bitcoin/comments/1yzil4/i_implemented_gmaxwells/cfp50ib)


